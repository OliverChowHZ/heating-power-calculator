<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ çƒ­ç³»ç»ŸåŠŸç‡æ™ºç®—å¸ˆ v1.6</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header - å·¥ä¸šæ·±è“é£æ ¼ */
        .header {
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(26, 54, 93, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #e53e3e, #dd6b20);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 2px 8px rgba(229, 62, 62, 0.4);
        }
        
        .header h1 {
            font-size: 22px;
            color: #ffffff;
        }
        
        .header p {
            font-size: 13px;
            color: #a0aec0;
        }
        
        .btn-reset {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            color: #ffffff;
        }
        
        .btn-reset:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        
        /* Progress */
        .progress-container {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: #4a5568;
        }
        
        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2c5282, #1a365d);
            transition: width 0.3s ease;
        }
        
        /* Steps */
        .steps-container {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow-x: auto;
            border: 1px solid #e2e8f0;
        }
        
        .steps {
            display: flex;
            justify-content: space-between;
            min-width: 600px;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            border: 2px solid #cbd5e0;
            background: #f7fafc;
            color: #a0aec0;
            transition: all 0.3s;
        }
        
        .step.active .step-circle {
            border-color: #2c5282;
            background: #ebf4ff;
            color: #2c5282;
        }
        
        .step.completed .step-circle {
            border-color: #38a169;
            background: #c6f6d5;
            color: #38a169;
        }
        
        .step-label {
            font-size: 12px;
            margin-top: 8px;
            color: #a0aec0;
            text-align: center;
        }
        
        .step.active .step-label,
        .step.completed .step-label {
            color: #2d3748;
        }
        
        .step-line {
            flex: 1;
            height: 2px;
            background: #cbd5e0;
            margin: 20px 5px 0;
        }
        
        .step.completed + .step-line,
        .step.completed .step-line {
            background: #38a169;
        }
        
        /* Main Card */
        .main-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .card-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e2e8f0;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        }
        
        .card-title {
            font-size: 18px;
            color: #1a365d;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title .icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #e53e3e, #dd6b20);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .card-desc {
            font-size: 14px;
            color: #718096;
            margin-top: 5px;
        }
        
        .card-content {
            padding: 30px;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #2d3748;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #2c5282;
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.15);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }
        
        .form-select:focus {
            outline: none;
            border-color: #2c5282;
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.15);
        }
        
        /* Buttons */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2c5282, #1a365d);
            color: white;
            box-shadow: 0 2px 8px rgba(44, 82, 130, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #1a365d, #1a365d);
            box-shadow: 0 4px 12px rgba(44, 82, 130, 0.4);
        }
        
        .btn-secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #cbd5e0;
        }
        
        .btn-secondary:hover {
            background: #edf2f7;
        }
        
        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #38a169, #2f855a);
            color: white;
            box-shadow: 0 2px 8px rgba(56, 161, 105, 0.3);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #2f855a, #276749);
        }
        
        /* Navigation */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        /* Substance Grid */
        .substance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            max-height: 350px;
            overflow-y: auto;
            padding: 5px;
        }
        
        .substance-card {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .substance-card:hover {
            border-color: #2c5282;
            background: #f7fafc;
        }
        
        .substance-card.selected {
            border-color: #2c5282;
            background: #ebf4ff;
        }
        
        .substance-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 5px;
            color: #1a365d;
        }
        
        .substance-en {
            font-size: 12px;
            color: #718096;
            margin-bottom: 8px;
        }
        
        .substance-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .badge-liquid {
            background: #bee3f8;
            color: #2b6cb0;
        }
        
        .badge-gas {
            background: #c6f6d5;
            color: #276749;
        }
        
        .badge-oil {
            background: #feebc8;
            color: #c05621;
        }
        
        .badge-other {
            background: #e9d8fd;
            color: #6b46c1;
        }
        
        .substance-props {
            font-size: 12px;
            color: #4a5568;
            margin-top: 8px;
        }
        
        /* Alert */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #c6f6d5;
            border: 1px solid #9ae6b4;
            color: #276749;
        }
        
        .alert-info {
            background: #ebf4ff;
            border: 1px solid #bee3f8;
            color: #2b6cb0;
        }
        
        .alert-warning {
            background: #feebc8;
            border: 1px solid #fbd38d;
            color: #c05621;
        }
        
        .alert-error {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #c53030;
        }
        
        /* Pressure Selection */
        .pressure-selection {
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .pressure-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1a365d;
        }
        
        .pressure-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .pressure-btn {
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            text-align: center;
        }
        
        .pressure-btn:hover {
            border-color: #2c5282;
        }
        
        .pressure-btn.active {
            border-color: #2c5282;
            background: #ebf4ff;
            color: #2c5282;
        }
        
        .pressure-btn .pressure-value {
            font-weight: 600;
            font-size: 16px;
        }
        
        .pressure-btn .pressure-density {
            font-size: 11px;
            color: #718096;
            margin-top: 4px;
        }
        
        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .data-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }
        
        .data-table td {
            color: #4a5568;
        }
        
        /* Result */
        .result-box {
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            color: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(26, 54, 93, 0.3);
        }
        
        .result-power {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .result-unit {
            font-size: 24px;
            opacity: 0.9;
        }
        
        .formula-box {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            font-family: "Courier New", monospace;
            font-size: 14px;
            white-space: pre-wrap;
            line-height: 1.6;
            color: #2d3748;
        }
        
        /* Toggle Buttons */
        .toggle-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .toggle-btn {
            padding: 10px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            color: #4a5568;
        }
        
        .toggle-btn:hover {
            border-color: #a0aec0;
        }
        
        .toggle-btn.active {
            border-color: #2c5282;
            background: #ebf4ff;
            color: #2c5282;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: #718096;
            font-size: 13px;
        }
        
        /* Hidden */
        .hidden {
            display: none !important;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        }
        
        .modal-header h3 {
            color: #1a365d;
            font-size: 18px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #718096;
            padding: 0;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: #2d3748;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 15px 25px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        /* Add Steps */
        .add-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .add-step {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .add-step-num {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #e2e8f0;
            color: #718096;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .add-step.active .add-step-num {
            background: #2c5282;
            color: white;
        }
        
        .add-step.completed .add-step-num {
            background: #38a169;
            color: white;
        }
        
        .add-step-label {
            font-size: 11px;
            color: #718096;
            margin-top: 5px;
            text-align: center;
        }
        
        .add-step.active .add-step-label,
        .add-step.completed .add-step-label {
            color: #2d3748;
        }
        
        .add-step-line {
            width: 60px;
            height: 2px;
            background: #e2e8f0;
            margin: 0 10px;
            margin-bottom: 25px;
        }
        
        /* Category Options */
        .category-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }
        
        .category-btn {
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .category-btn:hover {
            border-color: #2c5282;
            background: #f7fafc;
        }
        
        .category-btn.selected {
            border-color: #2c5282;
            background: #ebf4ff;
        }
        
        .category-icon {
            font-size: 32px;
            display: block;
            margin-bottom: 8px;
        }
        
        .category-name {
            font-size: 14px;
            font-weight: 500;
            color: #2d3748;
        }
        
        /* Custom badge */
        .badge-custom {
            background: #fed7e2;
            color: #c53030;
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .substance-grid {
                grid-template-columns: 1fr;
            }
            
            .pressure-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="logo">ğŸ”¥</div>
                <div>
                    <h1>åŠ çƒ­ç³»ç»ŸåŠŸç‡æ™ºç®—å¸ˆ</h1>
                    <p>ç”µåŠ çƒ­å™¨åŠŸç‡è®¡ç®—ä¸“å®¶ v1.6</p>
                </div>
            </div>
            <button class="btn-reset" onclick="resetAll()">ğŸ”„ é‡æ–°å¼€å§‹ Reset</button>
        </div>
        
        <!-- Progress -->
        <div class="progress-container">
            <div class="progress-info">
                <span>è®¡ç®—è¿›åº¦ Progress</span>
                <span id="progressText">æ­¥éª¤ 1 / 7</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- Steps -->
        <div class="steps-container">
            <div class="steps">
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-label">é€‰æ‹©ç‰©è´¨<br>Select</div>
                </div>
                <div class="step-line"></div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-label">è¾“å…¥æ•°é‡<br>Quantity</div>
                </div>
                <div class="step-line"></div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-label">æ¸©åº¦å‚æ•°<br>Temperature</div>
                </div>
                <div class="step-line"></div>
                <div class="step" id="step4">
                    <div class="step-circle">4</div>
                    <div class="step-label">åŠ çƒ­æ—¶é—´<br>Time</div>
                </div>
                <div class="step-line"></div>
                <div class="step" id="step5">
                    <div class="step-circle">5</div>
                    <div class="step-label">å†—ä½™ç³»æ•°<br>Factor</div>
                </div>
                <div class="step-line"></div>
                <div class="step" id="step6">
                    <div class="step-circle">6</div>
                    <div class="step-label">æ•°æ®æ±‡æ€»<br>Summary</div>
                </div>
                <div class="step-line"></div>
                <div class="step" id="step7">
                    <div class="step-circle">7</div>
                    <div class="step-label">è®¡ç®—ç»“æœ<br>Result</div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-card">
            <!-- Step 1: é€‰æ‹©ç‰©è´¨ -->
            <div id="content1">
                <div class="card-header">
                    <div class="card-title">
                        <span class="icon">ğŸ§ª</span>
                        Step 1: é€‰æ‹©ç‰©è´¨ Select Substance
                    </div>
                    <div class="card-desc">ç¡®è®¤è¢«åŠ çƒ­ç‰©è´¨ Confirm the substance to be heated</div>
                </div>
                <div class="card-content">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h3 style="font-size: 18px; margin-bottom: 8px;">è¯·é—®è¢«åŠ çƒ­çš„ç‰©è´¨æ˜¯ä»€ä¹ˆï¼Ÿ</h3>
                        <p style="color: #666;">é€‰æ‹©æˆ–æœç´¢ç‰©è´¨åç§°ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è·å–å…¶ç‰©æ€§å‚æ•°</p>
                    </div>
                    
                    <div class="form-group">
                        <input type="text" class="form-input" id="searchInput" placeholder="æœç´¢ç‰©è´¨åç§°ï¼ˆå¦‚ï¼šæ°´ã€ç©ºæ°”ã€æŸ´æ²¹...ï¼‰" oninput="filterSubstances()">
                    </div>
                    
                    <div class="toggle-group">
                        <button class="toggle-btn active" onclick="filterByCategory('all', this)">å…¨éƒ¨ All</button>
                        <button class="toggle-btn" onclick="filterByCategory('liquid', this)">æ¶²ä½“ Liquid</button>
                        <button class="toggle-btn" onclick="filterByCategory('gas', this)">æ°”ä½“ Gas</button>
                        <button class="toggle-btn" onclick="filterByCategory('oil', this)">æ²¹ç±» Oil</button>
                        <button class="toggle-btn" onclick="filterByCategory('other', this)">å…¶ä»– Other</button>
                    </div>
                    
                    <div class="substance-grid" id="substanceGrid"></div>
                    
                    <!-- æ‰‹åŠ¨æ·»åŠ ç‰©è´¨æŒ‰é’® -->
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-secondary" onclick="showAddSubstanceModal()" style="padding: 15px 30px;">
                            â• æ‰‹åŠ¨æ·»åŠ ç‰©è´¨ Add Custom Substance
                        </button>
                    </div>
                    
                    <!-- å¯¼å‡º/å¯¼å…¥å¤‡ä»½ -->
                    <div style="margin-top: 15px; text-align: center; padding: 15px; background: #f7fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <div style="font-size: 13px; color: #718096; margin-bottom: 10px;">
                            ğŸ’¾ è‡ªå®šä¹‰ç‰©è´¨å¤‡ä»½ Custom Substance Backup
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="exportCustomSubstances()" style="padding: 10px 20px; font-size: 13px;">
                                ğŸ“¤ å¯¼å‡ºå¤‡ä»½ Export
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()" style="padding: 10px 20px; font-size: 13px;">
                                ğŸ“¥ å¯¼å…¥å¤‡ä»½ Import
                            </button>
                            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importCustomSubstances(event)">
                        </div>
                        <div id="customCount" style="font-size: 12px; color: #a0aec0; margin-top: 8px;"></div>
                    </div>
                    
                    <!-- æ°”ä½“å‹åŠ›é€‰æ‹© -->
                    <div id="pressureSelection" class="pressure-selection hidden">
                        <div class="pressure-title">ğŸŒ¡ï¸ é€‰æ‹©æ°”ä½“å·¥ä½œå‹åŠ› Select Gas Pressureï¼ˆå½±å“å¯†åº¦ Affects Densityï¼‰</div>
                        <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                            æ°”ä½“å¯†åº¦ä¸å‹åŠ›æˆæ­£æ¯”ï¼Œè¯·é€‰æ‹©å®é™…å·¥ä½œå‹åŠ›ï¼š<br>
                            Gas density is proportional to pressure. Please select the actual working pressure:
                        </p>
                        <div class="pressure-options" id="pressureOptions"></div>
                    </div>
                    
                    <div id="selectedSubstance" class="alert alert-success hidden" style="margin-top: 20px;">
                        <strong>å·²é€‰æ‹© Selectedï¼š</strong><span id="selectedName"></span><br>
                        <span id="selectedProps"></span>
                    </div>
                    
                    <div id="error1" class="alert alert-error hidden"></div>
                </div>
            </div>
            
            <!-- Step 2: è¾“å…¥æ•°é‡ -->
            <div id="content2" class="hidden">
                <div class="card-header">
                    <div class="card-title">
                        <span class="icon">âš–ï¸</span>
                        Step 2: è¾“å…¥æ•°é‡ Input Quantity
                    </div>
                    <div class="card-desc">è´¨é‡/ä½“ç§¯/æµé‡ Mass/Volume/Flow</div>
                </div>
                <div class="card-content">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h3 style="font-size: 18px; margin-bottom: 8px;">è¯·é—®è¢«åŠ çƒ­ç‰©è´¨çš„è´¨é‡ã€æµé‡æˆ–ä½“ç§¯æ˜¯å¤šå°‘ï¼Ÿ</h3>
                        <p style="color: #666;">è¯·è¾“å…¥æ•°å€¼å¹¶é€‰æ‹©å•ä½</p>
                    </div>
                    
                    <div class="toggle-group">
                        <button class="toggle-btn active" id="btnMass" onclick="setInputType('mass')">è´¨é‡/ä½“ç§¯ Mass/Volume</button>
                        <button class="toggle-btn" id="btnFlow" onclick="setInputType('flow')">æµé‡ Flow</button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label" id="massLabel">è´¨é‡/ä½“ç§¯å€¼</label>
                            <input type="number" class="form-input" id="massValue" placeholder="ä¾‹å¦‚: 1000">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">å•ä½ Unit</label>
                            <select class="form-select" id="massUnit"></select>
                        </div>
                    </div>
                    
                    <div id="densityInfo" class="alert alert-info"></div>
                    <div id="error2" class="alert alert-error hidden"></div>
                </div>
            </div>
            
            <!-- Step 3: æ¸©åº¦å‚æ•° -->
            <div id="content3" class="hidden">
                <div class="card-header">
                    <div class="card-title">
                        <span class="icon">ğŸŒ¡ï¸</span>
                        Step 3: æ¸©åº¦å‚æ•° Temperature
                    </div>
                    <div class="card-desc">åˆå§‹æ¸©åº¦å’Œç›®æ ‡æ¸©åº¦ Initial and Target Temperature</div>
                </div>
                <div class="card-content">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h3 style="font-size: 18px; margin-bottom: 8px;">è¯·é—®è¢«åŠ çƒ­ç‰©è´¨çš„åˆå§‹æ¸©åº¦å’Œç›®æ ‡æ¸©åº¦åˆ†åˆ«æ˜¯å¤šå°‘ï¼Ÿ</h3>
                        <p style="color: #666;">å•ä½ï¼šæ‘„æ°åº¦ï¼ˆâ„ƒï¼‰</p>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">åˆå§‹æ¸©åº¦ Initial Temp (â„ƒ)</label>
                            <input type="number" class="form-input" id="initialTemp" placeholder="ä¾‹å¦‚: 20">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç›®æ ‡æ¸©åº¦ Target Temp (â„ƒ)</label>
                            <input type="number" class="form-input" id="targetTemp" placeholder="ä¾‹å¦‚: 60">
                        </div>
                    </div>
                    
                    <div id="tempRange" class="alert alert-info"></div>
                    
                    <div id="deltaT" class="alert alert-success hidden" style="text-align: center; font-weight: 500;"></div>
                    
                    <div id="error3" class="alert alert-error hidden"></div>
                </div>
            </div>
            
            <!-- Step 4: åŠ çƒ­æ—¶é—´ -->
            <div id="content4" class="hidden">
                <div class="card-header">
                    <div class="card-title">
                        <span class="icon">â±ï¸</span>
                        Step 4: åŠ çƒ­æ—¶é—´ Heating Time
                    </div>
                    <div class="card-desc">æœŸæœ›åŠ çƒ­æ—¶é—´ Expected Heating Time</div>
                </div>
                <div class="card-content">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h3 style="font-size: 18px; margin-bottom: 8px;">è¯·é—®æœŸæœ›çš„åŠ çƒ­æ—¶é—´æ˜¯å¤šå°‘ï¼Ÿ</h3>
                        <p style="color: #666;">é€‰æ‹©æ—¶é—´å•ä½å¹¶è¾“å…¥æ•°å€¼</p>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">åŠ çƒ­æ—¶é—´ Time</label>
                            <input type="number" class="form-input" id="heatingTime" placeholder="ä¾‹å¦‚: 30">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">å•ä½ Unit</label>
                            <select class="form-select" id="timeUnit">
                                <option value="min">åˆ†é’Ÿ (min)</option>
                                <option value="h">å°æ—¶ (h)</option>
                                <option value="s">ç§’ (s)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="error4" class="alert alert-error hidden"></div>
                </div>
            </div>
            
            <!-- Step 5: å†—ä½™ç³»æ•° -->
            <div id="content5" class="hidden">
                <div class="card-header">
                    <div class="card-title">
                        <span class="icon">âš™ï¸</span>
                        Step 5: å†—ä½™ç³»æ•° Redundancy Factor
                    </div>
                    <div class="card-desc">åŠŸç‡å†—ä½™è®¾ç½® Power Redundancy Setting</div>
                </div>
                <div class="card-content">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h3 style="font-size: 18px; margin-bottom: 8px;">è¯·é—®åŠŸç‡å†—ä½™ç³»æ•°è®¾ç½®ä¸ºå¤šå°‘ï¼Ÿ</h3>
                        <p style="color: #666;">å†—ä½™ç³»æ•°ç”¨äºè¡¥å¿çƒ­æŸå¤±å’Œç¡®ä¿å®‰å…¨è£•åº¦</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å†—ä½™ç³»æ•° Factor (K)</label>
                        <input type="number" class="form-input" id="redundancyFactor" value="1.2" step="0.05" min="1" max="3">
                    </div>
                    
                    <div class="btn-group">
                        <button class="toggle-btn" onclick="setRedundancy(1.1)">1.1 (æ¶²ä½“æ¨è Liquid)</button>
                        <button class="toggle-btn" onclick="setRedundancy(1.2)">1.2 (ä¸€èˆ¬å·¥å†µ General)</button>
                        <button class="toggle-btn" onclick="setRedundancy(1.25)">1.25 (æ°”ä½“æ¨è Gas)</button>
                    </div>
                    
                    <div class="alert alert-info" style="margin-top: 20px;">
                        <strong>å†—ä½™ç³»æ•°è¯´æ˜ Descriptionï¼š</strong><br>
                        â€¢ ç©ºæ°”ä¸­åŠ çƒ­ Air heatingï¼šå»ºè®® 1.25ï¼ˆçƒ­æŸå¤±è¾ƒå¤§ large heat lossï¼‰<br>
                        â€¢ æ¶²ä½“ä¸­åŠ çƒ­ Liquid heatingï¼šå»ºè®® 1.1ï¼ˆçƒ­æŸå¤±è¾ƒå° small heat lossï¼‰<br>
                        â€¢ ä¿æ¸©è‰¯å¥½ Good insulationï¼šå¯é€‚å½“é™ä½ can be lower<br>
                        â€¢ ä¿æ¸©è¾ƒå·® Poor insulationï¼šå¯é€‚å½“æé«˜ can be higher
                    </div>
                    
                    <div id="error5" class="alert alert-error hidden"></div>
                </div>
            </div>
            
            <!-- Step 6: æ•°æ®æ±‡æ€» -->
            <div id="content6" class="hidden">
                <div class="card-header">
                    <div class="card-title">
                        <span class="icon">âœ…</span>
                        Step 6: æ•°æ®æ±‡æ€» Summary
                    </div>
                    <div class="card-desc">ç¡®è®¤å‚æ•° Confirm Parameters</div>
                </div>
                <div class="card-content">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h3 style="font-size: 18px; margin-bottom: 8px;">è¯·ç¡®è®¤ä»¥ä¸‹å‚æ•°</h3>
                        <p style="color: #666;">æ‰€æœ‰æ•°æ®å·²ç»Ÿä¸€ä¸ºå›½é™…å•ä½åˆ¶</p>
                    </div>
                    
                    <table class="data-table" id="summaryTable">
                        <thead>
                            <tr>
                                <th>å‚æ•°åç§° Parameter</th>
                                <th>æ•°å€¼ Value</th>
                                <th>å•ä½ Unit</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    
                    <div id="propsSummary" class="alert alert-info" style="margin-top: 20px;"></div>
                </div>
            </div>
            
            <!-- Step 7: è®¡ç®—ç»“æœ -->
            <div id="content7" class="hidden">
                <div class="card-header">
                    <div class="card-title">
                        <span class="icon">ğŸ§®</span>
                        Step 7: è®¡ç®—ç»“æœ Result
                    </div>
                    <div class="card-desc">åŠŸç‡è¾“å‡º Power Output</div>
                </div>
                <div class="card-content">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h3 style="font-size: 18px; margin-bottom: 8px;">è®¡ç®—å®Œæˆ Calculation Complete</h3>
                        <p style="color: #666;">æ ¹æ®ä»¥ä¸Šå‚æ•°è®¡ç®—ï¼Œè¯¥ç”µåŠ çƒ­å™¨æ‰€éœ€åŠŸç‡ä¸ºï¼š</p>
                    </div>
                    
                    <div class="result-box">
                        <div class="result-power" id="resultPower">0.00</div>
                        <div class="result-unit">KW</div>
                    </div>
                    
                    <h4 style="margin-bottom: 10px;">ğŸ“ è®¡ç®—å…¬å¼ Formula</h4>
                    <div class="formula-box" id="formulaBox"></div>
                    
                    <h4 style="margin: 20px 0 10px;">ğŸ“Š è®¡ç®—å‚æ•° Parameters</h4>
                    <table class="data-table" id="resultTable">
                        <thead>
                            <tr>
                                <th>å‚æ•° Parameter</th>
                                <th>æ•°å€¼ Value</th>
                                <th>å•ä½ Unit</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Navigation Buttons -->
            <div style="padding: 0 30px 30px;">
                <div class="nav-buttons">
                    <button class="btn btn-secondary" id="prevBtn" onclick="prevStep()" disabled>â† ä¸Šä¸€æ­¥ Previous</button>
                    <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">ä¸‹ä¸€æ­¥ Next â†’</button>
                    <button class="btn btn-success hidden" id="calcBtn" onclick="calculate()">ğŸ§® å¼€å§‹è®¡ç®— Calculate</button>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>åŠ çƒ­ç³»ç»ŸåŠŸç‡æ™ºç®—å¸ˆ v1.6 | ä¸“ä¸šçš„ç”µåŠ çƒ­å™¨åŠŸç‡è®¡ç®—å·¥å…·</p>
            <p style="margin-top: 5px;">è®¡ç®—å…¬å¼: P(KW) = C Ã— m Ã— Î”T / (t Ã— 3600 Ã— 1000) Ã— K</p>
            <p style="margin-top: 8px; color: #999;">Author: OliverChow | Email: zhougw@gmail.com</p>
        </div>
    </div>

    <!-- æ·»åŠ ç‰©è´¨æ¨¡æ€æ¡† -->
    <div id="addSubstanceModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>â• æ‰‹åŠ¨æ·»åŠ ç‰©è´¨ Add Custom Substance</h3>
                <button class="modal-close" onclick="closeAddSubstanceModal()">Ã—</button>
            </div>
            
            <div class="modal-body">
                <!-- æ­¥éª¤æŒ‡ç¤º -->
                <div class="add-steps">
                    <div class="add-step active" id="addStep1">
                        <div class="add-step-num">1</div>
                        <div class="add-step-label">é€‰æ‹©åˆ†ç±»<br>Category</div>
                    </div>
                    <div class="add-step-line"></div>
                    <div class="add-step" id="addStep2">
                        <div class="add-step-num">2</div>
                        <div class="add-step-label">è¾“å…¥åç§°<br>Name</div>
                    </div>
                    <div class="add-step-line"></div>
                    <div class="add-step" id="addStep3">
                        <div class="add-step-num">3</div>
                        <div class="add-step-label">è¾“å…¥ç‰©æ€§<br>Properties</div>
                    </div>
                </div>

                <!-- æ­¥éª¤1: é€‰æ‹©åˆ†ç±» -->
                <div id="addContent1">
                    <div class="form-group" style="margin-top: 20px;">
                        <label class="form-label">è¯·é€‰æ‹©ç‰©è´¨åˆ†ç±» Select Category</label>
                        <div class="category-options">
                            <button class="category-btn" onclick="selectAddCategory('liquid')">
                                <span class="category-icon">ğŸ’§</span>
                                <span class="category-name">æ¶²ä½“ Liquid</span>
                            </button>
                            <button class="category-btn" onclick="selectAddCategory('gas')">
                                <span class="category-icon">ğŸ’¨</span>
                                <span class="category-name">æ°”ä½“ Gas</span>
                            </button>
                            <button class="category-btn" onclick="selectAddCategory('oil')">
                                <span class="category-icon">ğŸ›¢ï¸</span>
                                <span class="category-name">æ²¹ç±» Oil</span>
                            </button>
                            <button class="category-btn" onclick="selectAddCategory('other')">
                                <span class="category-icon">ğŸ“¦</span>
                                <span class="category-name">å…¶ä»– Other</span>
                            </button>
                        </div>
                    </div>
                    <div id="addError1" class="alert alert-error hidden" style="margin-top: 15px;"></div>
                </div>

                <!-- æ­¥éª¤2: è¾“å…¥åç§° -->
                <div id="addContent2" class="hidden">
                    <div class="form-group" style="margin-top: 20px;">
                        <label class="form-label">ä¸­æ–‡åç§° Chinese Name</label>
                        <input type="text" class="form-input" id="customNameCn" placeholder="ä¾‹å¦‚ï¼šç‰¹ç§å†·å´æ¶²">
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label class="form-label">è‹±æ–‡åç§° English Name</label>
                        <input type="text" class="form-input" id="customNameEn" placeholder="ä¾‹å¦‚ï¼šSpecial Coolant">
                    </div>
                    <div id="addError2" class="alert alert-error hidden" style="margin-top: 15px;"></div>
                </div>

                <!-- æ­¥éª¤3: è¾“å…¥ç‰©æ€§ -->
                <div id="addContent3" class="hidden">
                    <div class="form-row" style="margin-top: 20px;">
                        <div class="form-group">
                            <label class="form-label">å¯†åº¦ Density (kg/mÂ³)</label>
                            <input type="number" class="form-input" id="customDensity" placeholder="ä¾‹å¦‚ï¼š1000" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ¯”çƒ­å®¹ Cp (J/(kgÂ·K))</label>
                            <input type="number" class="form-input" id="customSpecificHeat" placeholder="ä¾‹å¦‚ï¼š4000" step="1">
                        </div>
                    </div>
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-group">
                            <label class="form-label">æœ€ä½æ¸©åº¦ Min Temp (â„ƒ)</label>
                            <input type="number" class="form-input" id="customTempMin" placeholder="ä¾‹å¦‚ï¼š0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æœ€é«˜æ¸©åº¦ Max Temp (â„ƒ)</label>
                            <input type="number" class="form-input" id="customTempMax" placeholder="ä¾‹å¦‚ï¼š100">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label class="form-label">æè¿° Description (å¯é€‰ optional)</label>
                        <input type="text" class="form-input" id="customDescription" placeholder="ä¾‹å¦‚ï¼šè‡ªå®šä¹‰å†·å´æ¶²">
                    </div>
                    <div id="addError3" class="alert alert-error hidden" style="margin-top: 15px;"></div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" id="addPrevBtn" onclick="prevAddStep()" disabled>â† ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" id="addNextBtn" onclick="nextAddStep()">ä¸‹ä¸€æ­¥ â†’</button>
                <button class="btn btn-success hidden" id="addSaveBtn" onclick="saveCustomSubstance()">ğŸ’¾ ä¿å­˜ Save</button>
            </div>
        </div>
    </div>

    <script>
        // ç‰©æ€§å‚æ•°æ•°æ®åº“
        const substanceDatabase = [
            // æ¶²ä½“ç±»
            { name: 'æ°´', nameEn: 'Water', category: 'liquid', density: 998.2, specificHeat: 4182, boilingPoint: 100, meltingPoint: 0, description: 'æœ€å¸¸è§çš„åŠ çƒ­ä»‹è´¨', tempMin: 0, tempMax: 100 },
            { name: 'ä¹™é†‡', nameEn: 'Ethanol', category: 'liquid', density: 789, specificHeat: 2440, boilingPoint: 78.4, meltingPoint: -114.1, description: 'é…’ç²¾ï¼Œå¸¸ç”¨ä½œæº¶å‰‚å’Œç‡ƒæ–™', tempMin: -114, tempMax: 78 },
            { name: 'ç”²é†‡', nameEn: 'Methanol', category: 'liquid', density: 791.8, specificHeat: 2530, boilingPoint: 64.7, meltingPoint: -97.6, description: 'æœ¨ç²¾ï¼Œå·¥ä¸šå¸¸ç”¨æº¶å‰‚', tempMin: -97, tempMax: 64 },
            { name: 'ä¸™é…®', nameEn: 'Acetone', category: 'liquid', density: 784.5, specificHeat: 2170, boilingPoint: 56, meltingPoint: -94.9, description: 'å¸¸ç”¨æœ‰æœºæº¶å‰‚', tempMin: -94, tempMax: 56 },
            { name: 'ç”˜æ²¹', nameEn: 'Glycerol', category: 'liquid', density: 1261, specificHeat: 2430, boilingPoint: 290, meltingPoint: 17.8, description: 'ä¸™ä¸‰é†‡ï¼Œé«˜æ²¸ç‚¹æ¶²ä½“', tempMin: 18, tempMax: 290 },
            { name: 'ä¹™äºŒé†‡', nameEn: 'Ethylene Glycol', category: 'liquid', density: 1113, specificHeat: 2380, boilingPoint: 197.3, meltingPoint: -12.9, description: 'é˜²å†»æ¶²ä¸»è¦æˆåˆ†', tempMin: -12, tempMax: 197 },
            { name: 'è‹¯', nameEn: 'Benzene', category: 'liquid', density: 876.5, specificHeat: 1740, boilingPoint: 80.1, meltingPoint: 5.5, description: 'èŠ³é¦™çƒƒï¼Œå·¥ä¸šåŸæ–™', tempMin: 5, tempMax: 80 },
            { name: 'ç”²è‹¯', nameEn: 'Toluene', category: 'liquid', density: 866.9, specificHeat: 1670, boilingPoint: 110.6, meltingPoint: -95, description: 'å·¥ä¸šæº¶å‰‚', tempMin: -95, tempMax: 110 },
            { name: 'äºŒç”²è‹¯', nameEn: 'Xylene', category: 'liquid', density: 860, specificHeat: 1720, boilingPoint: 138.5, meltingPoint: -47.4, description: 'æ²¹æ¼†ç¨€é‡Šå‰‚', tempMin: -47, tempMax: 138 },
            { name: 'æ¶²æ°¨', nameEn: 'Liquid Ammonia', category: 'liquid', density: 682, specificHeat: 4700, boilingPoint: -33.3, meltingPoint: -77.7, description: 'åˆ¶å†·å‰‚ï¼Œå·¥ä¸šåŸæ–™', tempMin: -77, tempMax: -33 },
            { name: 'æµ·æ°´', nameEn: 'Seawater', category: 'liquid', density: 1025, specificHeat: 3900, boilingPoint: 100.7, meltingPoint: -1.9, description: 'å«ç›é‡çº¦3.5%çš„æ°´', tempMin: -1.9, tempMax: 100 },
            { name: 'ç›æ°´(10%)', nameEn: 'Brine 10%', category: 'liquid', density: 1070, specificHeat: 3700, boilingPoint: 101.5, meltingPoint: -6.5, description: '10%æ°¯åŒ–é’ æº¶æ¶²', tempMin: -6, tempMax: 101 },
            { name: 'å†·å´æ¶²(50%æ°´+50%ä¹™äºŒé†‡)', nameEn: 'Coolant 50/50', category: 'liquid', density: 1075, specificHeat: 3400, boilingPoint: 107, meltingPoint: -36, description: 'é˜²å†»å†·å´æ¶²ï¼Œå†°ç‚¹ä½ã€æ²¸ç‚¹é«˜', tempMin: -36, tempMax: 107 },
            
            // æ²¹ç±»
            { name: 'å˜å‹å™¨æ²¹', nameEn: 'Transformer Oil', category: 'oil', density: 880, specificHeat: 1900, boilingPoint: 300, meltingPoint: -45, description: 'ç»ç¼˜æ²¹ï¼Œç”¨äºå˜å‹å™¨å†·å´', tempMin: -45, tempMax: 300 },
            { name: 'æ¶²å‹æ²¹', nameEn: 'Hydraulic Oil', category: 'oil', density: 870, specificHeat: 1900, boilingPoint: 310, meltingPoint: -30, description: 'æ¶²å‹ç³»ç»Ÿå·¥ä½œä»‹è´¨', tempMin: -30, tempMax: 310 },
            { name: 'æ¶¦æ»‘æ²¹', nameEn: 'Lubricating Oil', category: 'oil', density: 880, specificHeat: 1850, boilingPoint: 350, meltingPoint: -20, description: 'æœºæ¢°æ¶¦æ»‘ç”¨æ²¹', tempMin: -20, tempMax: 350 },
            { name: 'æŸ´æ²¹', nameEn: 'Diesel', category: 'oil', density: 840, specificHeat: 2100, boilingPoint: 180, meltingPoint: -30, description: 'æŸ´æ²¹å‘åŠ¨æœºç‡ƒæ–™', tempMin: -30, tempMax: 180 },
            { name: 'æ±½æ²¹', nameEn: 'Gasoline', category: 'oil', density: 720, specificHeat: 2200, boilingPoint: 95, meltingPoint: -60, description: 'æ±½æ²¹å‘åŠ¨æœºç‡ƒæ–™', tempMin: -60, tempMax: 95 },
            { name: 'ç…¤æ²¹', nameEn: 'Kerosene', category: 'oil', density: 800, specificHeat: 2100, boilingPoint: 175, meltingPoint: -40, description: 'èˆªç©ºç…¤æ²¹ã€ç…§æ˜ç”¨æ²¹', tempMin: -40, tempMax: 175 },
            { name: 'åŸæ²¹', nameEn: 'Crude Oil', category: 'oil', density: 850, specificHeat: 2000, boilingPoint: 300, meltingPoint: -20, description: 'æœªåŠ å·¥çŸ³æ²¹', tempMin: -20, tempMax: 300 },
            { name: 'ç¡…æ²¹', nameEn: 'Silicone Oil', category: 'oil', density: 960, specificHeat: 1500, boilingPoint: 250, meltingPoint: -50, description: 'é«˜æ¸©ç¨³å®šä»‹è´¨', tempMin: -50, tempMax: 250 },
            { name: 'å¯¼çƒ­æ²¹', nameEn: 'Heat Transfer Oil', category: 'oil', density: 860, specificHeat: 2100, boilingPoint: 350, meltingPoint: -10, description: 'é«˜æ¸©ä¼ çƒ­ä»‹è´¨', tempMin: -10, tempMax: 350 },
            { name: 'èœç±½æ²¹', nameEn: 'Rapeseed Oil', category: 'oil', density: 920, specificHeat: 1800, boilingPoint: 230, meltingPoint: -10, description: 'é£Ÿç”¨æ²¹', tempMin: -10, tempMax: 230 },
            { name: 'å¤§è±†æ²¹', nameEn: 'Soybean Oil', category: 'oil', density: 920, specificHeat: 1850, boilingPoint: 230, meltingPoint: -16, description: 'é£Ÿç”¨æ²¹', tempMin: -16, tempMax: 230 },
            { name: 'é‡æ²¹', nameEn: 'Heavy Fuel Oil', category: 'oil', density: 960, specificHeat: 1800, boilingPoint: 450, meltingPoint: 10, description: 'èˆ¹èˆ¶ç‡ƒæ–™æ²¹ï¼Œé«˜ç²˜åº¦', tempMin: 10, tempMax: 450 },
            
            // å…¶ä»–ç±»
            { name: 'äºŒå…ƒç†”ç›(60%NaNOâ‚ƒ+40%KNOâ‚ƒ)', nameEn: 'Binary Salt (Solar Salt)', category: 'other', density: 1850, specificHeat: 1500, boilingPoint: 600, meltingPoint: 220, description: 'å¤ªé˜³èƒ½ç†”ç›ï¼Œé«˜æ¸©ä¼ çƒ­ä»‹è´¨', tempMin: 220, tempMax: 600 },
            { name: 'ä¸‰å…ƒç†”ç›(Hitec)', nameEn: 'Ternary Salt (Hitec)', category: 'other', density: 1750, specificHeat: 1560, boilingPoint: 450, meltingPoint: 142, description: 'ä½ç†”ç‚¹ç†”ç›ï¼Œå·¥ä½œæ¸©åº¦èŒƒå›´å®½', tempMin: 142, tempMax: 450 },
            
            // æ°”ä½“ç±» - å¯†åº¦ä¸º1Barã€20â„ƒä¸‹çš„å€¼ï¼Œæ¯”çƒ­å®¹ä¸ºå®šå‹æ¯”çƒ­å®¹Cp
            { name: 'ç©ºæ°”', nameEn: 'Air', category: 'gas', density: 1.205, specificHeat: 1005, boilingPoint: -194.4, meltingPoint: -216.2, description: 'æœ€å¸¸è§çš„æ°”ä½“åŠ çƒ­ä»‹è´¨', tempMin: -100, tempMax: 1000, molarMass: 28.97 },
            { name: 'æ°®æ°”', nameEn: 'Nitrogen', category: 'gas', density: 1.165, specificHeat: 1040, boilingPoint: -195.8, meltingPoint: -210, description: 'æƒ°æ€§ä¿æŠ¤æ°”ä½“', tempMin: -100, tempMax: 1000, molarMass: 28.01 },
            { name: 'æ°§æ°”', nameEn: 'Oxygen', category: 'gas', density: 1.331, specificHeat: 920, boilingPoint: -183, meltingPoint: -218.4, description: 'åŠ©ç‡ƒæ°”ä½“', tempMin: -100, tempMax: 500, molarMass: 32.00 },
            { name: 'æ°¢æ°”', nameEn: 'Hydrogen', category: 'gas', density: 0.0838, specificHeat: 14300, boilingPoint: -252.8, meltingPoint: -259.2, description: 'é«˜æ¯”çƒ­å®¹æ°”ä½“', tempMin: -100, tempMax: 1000, molarMass: 2.016 },
            { name: 'æ°¦æ°”', nameEn: 'Helium', category: 'gas', density: 0.166, specificHeat: 5200, boilingPoint: -268.9, meltingPoint: -272.2, description: 'æƒ°æ€§æ°”ä½“ï¼Œé«˜æ¯”çƒ­å®¹', tempMin: -100, tempMax: 1000, molarMass: 4.003 },
            { name: 'äºŒæ°§åŒ–ç¢³', nameEn: 'Carbon Dioxide', category: 'gas', density: 1.842, specificHeat: 844, boilingPoint: -78.5, meltingPoint: -56.6, description: 'æ¸©å®¤æ°”ä½“ï¼Œç­ç«å‰‚', tempMin: -100, tempMax: 500, molarMass: 44.01 },
            { name: 'ç”²çƒ·', nameEn: 'Methane', category: 'gas', density: 0.668, specificHeat: 2200, boilingPoint: -161.5, meltingPoint: -182.5, description: 'å¤©ç„¶æ°”ä¸»è¦æˆåˆ†', tempMin: -100, tempMax: 500, molarMass: 16.04 },
            { name: 'ä¸™çƒ·', nameEn: 'Propane', category: 'gas', density: 1.864, specificHeat: 1640, boilingPoint: -42.1, meltingPoint: -187.7, description: 'æ¶²åŒ–çŸ³æ²¹æ°”æˆåˆ†', tempMin: -100, tempMax: 500, molarMass: 44.10 },
            { name: 'ä¸çƒ·', nameEn: 'Butane', category: 'gas', density: 2.493, specificHeat: 1670, boilingPoint: -0.5, meltingPoint: -138.4, description: 'æ¶²åŒ–çŸ³æ²¹æ°”æˆåˆ†', tempMin: -100, tempMax: 500, molarMass: 58.12 },
            { name: 'æ°¨æ°”', nameEn: 'Ammonia', category: 'gas', density: 0.681, specificHeat: 2200, boilingPoint: -33.3, meltingPoint: -77.7, description: 'åˆ¶å†·å‰‚', tempMin: -50, tempMax: 500, molarMass: 17.03 },
            { name: 'æ°´è’¸æ°”', nameEn: 'Steam', category: 'gas', density: 0.598, specificHeat: 2010, boilingPoint: 100, meltingPoint: 0, description: 'æ°´è’¸æ°”ï¼ŒåŠ çƒ­ä»‹è´¨', tempMin: 100, tempMax: 500, molarMass: 18.02 },
            { name: 'æ°©æ°”', nameEn: 'Argon', category: 'gas', density: 1.622, specificHeat: 520, boilingPoint: -185.8, meltingPoint: -189.3, description: 'æƒ°æ€§ä¿æŠ¤æ°”ä½“', tempMin: -100, tempMax: 1000, molarMass: 39.95 },
            { name: 'å¤©ç„¶æ°”', nameEn: 'Natural Gas', category: 'gas', density: 0.78, specificHeat: 2100, boilingPoint: -162, meltingPoint: -182, description: 'æ··åˆæ°”ä½“ï¼Œä»¥ç”²çƒ·ä¸ºä¸»', tempMin: -100, tempMax: 500, molarMass: 18.5 },
            { name: 'çƒŸæ°”', nameEn: 'Flue Gas', category: 'gas', density: 1.3, specificHeat: 1050, boilingPoint: -150, meltingPoint: -180, description: 'ç‡ƒçƒ§äº§ç‰©ï¼Œå«CO2ã€N2ç­‰', tempMin: -50, tempMax: 1500, molarMass: 29.5 }
        ];

        // å‹åŠ›ç­‰çº§é…ç½®
        const pressureLevels = [
            { bar: 1, label: '1 Bar (å¸¸å‹ Normal)' },
            { bar: 5, label: '5 Bar' },
            { bar: 10, label: '10 Bar' },
            { bar: 20, label: '20 Bar' }
        ];

        // å•ä½é…ç½®
        const massUnits = [
            { value: 'kg', label: 'åƒå…‹ (kg)', factor: 1, needsDensity: false },
            { value: 'g', label: 'å…‹ (g)', factor: 0.001, needsDensity: false },
            { value: 't', label: 'å¨ (t)', factor: 1000, needsDensity: false },
            { value: 'L', label: 'å‡ (L)', factor: 0.001, needsDensity: true },
            { value: 'mL', label: 'æ¯«å‡ (mL)', factor: 0.000001, needsDensity: true },
            { value: 'mÂ³', label: 'ç«‹æ–¹ç±³ (mÂ³)', factor: 1, needsDensity: true }
        ];

        const flowUnits = [
            { value: 'kg/h', label: 'åƒå…‹/å°æ—¶ (kg/h)', factor: 1, needsDensity: false },
            { value: 'kg/min', label: 'åƒå…‹/åˆ†é’Ÿ (kg/min)', factor: 60, needsDensity: false },
            { value: 'kg/s', label: 'åƒå…‹/ç§’ (kg/s)', factor: 3600, needsDensity: false },
            { value: 'L/h', label: 'å‡/å°æ—¶ (L/h)', factor: 0.001, needsDensity: true },
            { value: 'L/min', label: 'å‡/åˆ†é’Ÿ (L/min)', factor: 0.06, needsDensity: true },
            { value: 'L/s', label: 'å‡/ç§’ (L/s)', factor: 3.6, needsDensity: true },
            { value: 'mÂ³/h', label: 'ç«‹æ–¹ç±³/å°æ—¶ (mÂ³/h)', factor: 1, needsDensity: true }
        ];

        const timeFactors = { 's': 1/3600, 'min': 1/60, 'h': 1 };

        // çŠ¶æ€
        let currentStep = 1;
        let selectedSubstance = null;
        let selectedPressure = 1;
        let inputType = 'mass';
        let currentCategory = 'all';
        
        // æ·»åŠ ç‰©è´¨æ¨¡æ€æ¡†çŠ¶æ€
        let addStep = 1;
        let addCategory = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCustomSubstances();
            renderSubstances();
            updateUnitSelect();
        });
        
        // åŠ è½½è‡ªå®šä¹‰ç‰©è´¨
        function loadCustomSubstances() {
            const saved = localStorage.getItem('customSubstances');
            if (saved) {
                const customSubstances = JSON.parse(saved);
                customSubstances.forEach(s => {
                    if (!substanceDatabase.find(item => item.name === s.name)) {
                        substanceDatabase.push(s);
                    }
                });
            }
            updateCustomCount();
        }
        
        // ä¿å­˜è‡ªå®šä¹‰ç‰©è´¨åˆ°localStorage
        function saveCustomSubstanceToStorage(substance) {
            let customSubstances = JSON.parse(localStorage.getItem('customSubstances') || '[]');
            customSubstances.push(substance);
            localStorage.setItem('customSubstances', JSON.stringify(customSubstances));
            updateCustomCount();
        }
        
        // æ›´æ–°è‡ªå®šä¹‰ç‰©è´¨æ•°é‡æ˜¾ç¤º
        function updateCustomCount() {
            const customSubstances = JSON.parse(localStorage.getItem('customSubstances') || '[]');
            const countDiv = document.getElementById('customCount');
            if (customSubstances.length > 0) {
                countDiv.textContent = `å·²ä¿å­˜ ${customSubstances.length} ä¸ªè‡ªå®šä¹‰ç‰©è´¨ | ${customSubstances.length} custom substances saved`;
            } else {
                countDiv.textContent = 'æš‚æ— è‡ªå®šä¹‰ç‰©è´¨ | No custom substances';
            }
        }
        
        // å¯¼å‡ºè‡ªå®šä¹‰ç‰©è´¨
        function exportCustomSubstances() {
            const customSubstances = JSON.parse(localStorage.getItem('customSubstances') || '[]');
            
            if (customSubstances.length === 0) {
                alert('âš ï¸ æš‚æ— è‡ªå®šä¹‰ç‰©è´¨å¯å¯¼å‡º\nNo custom substances to export');
                return;
            }
            
            const exportData = {
                version: '1.5',
                exportDate: new Date().toISOString(),
                description: 'åŠ çƒ­ç³»ç»ŸåŠŸç‡æ™ºç®—å¸ˆ - è‡ªå®šä¹‰ç‰©è´¨å¤‡ä»½æ–‡ä»¶',
                descriptionEn: 'Heating Power Calculator - Custom Substances Backup',
                author: 'OliverChow',
                substances: customSubstances
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `custom_substances_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`âœ… å¯¼å‡ºæˆåŠŸï¼\nå·²å¯¼å‡º ${customSubstances.length} ä¸ªè‡ªå®šä¹‰ç‰©è´¨\nExported ${customSubstances.length} custom substances`);
        }
        
        // å¯¼å…¥è‡ªå®šä¹‰ç‰©è´¨
        function importCustomSubstances(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // éªŒè¯æ–‡ä»¶æ ¼å¼
                    if (!importData.substances || !Array.isArray(importData.substances)) {
                        throw new Error('Invalid file format');
                    }
                    
                    let addedCount = 0;
                    let duplicateCount = 0;
                    
                    importData.substances.forEach(s => {
                        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                        if (!substanceDatabase.find(item => item.name === s.name)) {
                            substanceDatabase.push(s);
                            addedCount++;
                        } else {
                            duplicateCount++;
                        }
                    });
                    
                    // åˆå¹¶åˆ°localStorage
                    let existingCustom = JSON.parse(localStorage.getItem('customSubstances') || '[]');
                    importData.substances.forEach(s => {
                        if (!existingCustom.find(item => item.name === s.name)) {
                            existingCustom.push(s);
                        }
                    });
                    localStorage.setItem('customSubstances', JSON.stringify(existingCustom));
                    
                    renderSubstances();
                    updateCustomCount();
                    
                    let message = `âœ… å¯¼å…¥å®Œæˆï¼\n`;
                    message += `æ–°å¢: ${addedCount} ä¸ªç‰©è´¨\n`;
                    if (duplicateCount > 0) {
                        message += `è·³è¿‡é‡å¤: ${duplicateCount} ä¸ªç‰©è´¨`;
                    }
                    alert(message);
                    
                } catch (error) {
                    alert('âŒ å¯¼å…¥å¤±è´¥ï¼æ–‡ä»¶æ ¼å¼æ— æ•ˆ\nImport failed! Invalid file format');
                }
            };
            reader.readAsText(file);
            
            // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }

        // æ¸²æŸ“ç‰©è´¨åˆ—è¡¨
        function renderSubstances() {
            const grid = document.getElementById('substanceGrid');
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = substanceDatabase.filter(s => {
                const matchSearch = s.name.toLowerCase().includes(search) || 
                                   s.nameEn.toLowerCase().includes(search);
                const matchCategory = currentCategory === 'all' || s.category === currentCategory;
                return matchSearch && matchCategory;
            });
            
            grid.innerHTML = filtered.map(s => {
                const displayDensity = s.category === 'gas' ? 
                    `${s.density} kg/mÂ³ (1Bar)` : 
                    `${s.density} kg/mÂ³`;
                
                const categoryLabels = {
                    'liquid': 'æ¶²ä½“',
                    'gas': 'æ°”ä½“',
                    'oil': 'æ²¹ç±»',
                    'other': 'å…¶ä»–'
                };
                    
                return `
                <div class="substance-card ${selectedSubstance?.name === s.name ? 'selected' : ''}" 
                     onclick="selectSubstance('${s.name}')">
                    <div class="substance-name">${s.name}</div>
                    <div class="substance-en">${s.nameEn}</div>
                    <span class="substance-badge badge-${s.category}">
                        ${categoryLabels[s.category]}
                    </span>
                    <div class="substance-props">
                        å¯†åº¦ Density: ${displayDensity}<br>
                        æ¯”çƒ­å®¹ Cp: ${s.specificHeat} J/(kgÂ·K)
                    </div>
                </div>
            `}).join('');
        }

        // æœç´¢è¿‡æ»¤
        function filterSubstances() {
            renderSubstances();
        }

        // åˆ†ç±»è¿‡æ»¤
        function filterByCategory(category, btn) {
            currentCategory = category;
            document.querySelectorAll('.toggle-group .toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderSubstances();
        }

        // é€‰æ‹©ç‰©è´¨
        function selectSubstance(name) {
            selectedSubstance = substanceDatabase.find(s => s.name === name);
            renderSubstances();
            
            if (selectedSubstance.category === 'gas') {
                showPressureSelection();
            } else {
                document.getElementById('pressureSelection').classList.add('hidden');
                selectedPressure = 1;
            }
            
            updateSelectedDisplay();
            
            const defaultK = selectedSubstance.category === 'gas' ? 1.25 : 1.1;
            document.getElementById('redundancyFactor').value = defaultK;
            
            updateDensityInfo();
            updateTempRange();
            
            hideError(1);
        }

        // æ˜¾ç¤ºå‹åŠ›é€‰æ‹©
        function showPressureSelection() {
            const container = document.getElementById('pressureSelection');
            const optionsDiv = document.getElementById('pressureOptions');
            
            const baseDensity = selectedSubstance.density;
            
            optionsDiv.innerHTML = pressureLevels.map(p => {
                const density = baseDensity * p.bar;
                return `
                    <button class="pressure-btn ${selectedPressure === p.bar ? 'active' : ''}" 
                            onclick="selectPressure(${p.bar})">
                        <div class="pressure-value">${p.label}</div>
                        <div class="pressure-density">å¯†åº¦ Density: ${density.toFixed(3)} kg/mÂ³</div>
                    </button>
                `;
            }).join('');
            
            container.classList.remove('hidden');
        }

        // é€‰æ‹©å‹åŠ›
        function selectPressure(bar) {
            selectedPressure = bar;
            showPressureSelection();
            updateSelectedDisplay();
            updateDensityInfo();
        }

        // æ›´æ–°å·²é€‰æ‹©æ˜¾ç¤º
        function updateSelectedDisplay() {
            document.getElementById('selectedSubstance').classList.remove('hidden');
            
            let density = selectedSubstance.density;
            let pressureInfo = '';
            
            if (selectedSubstance.category === 'gas') {
                density = selectedSubstance.density * selectedPressure;
                pressureInfo = ` (${selectedPressure}Bar)`;
            }
            
            document.getElementById('selectedName').textContent = 
                selectedSubstance.name + ' - ' + selectedSubstance.description;
            document.getElementById('selectedProps').textContent = 
                `å¯†åº¦ Density: ${density.toFixed(3)} kg/mÂ³${pressureInfo} | æ¯”çƒ­å®¹ Cp: ${selectedSubstance.specificHeat} J/(kgÂ·K)`;
        }

        // è®¾ç½®è¾“å…¥ç±»å‹
        function setInputType(type) {
            inputType = type;
            document.getElementById('btnMass').classList.toggle('active', type === 'mass');
            document.getElementById('btnFlow').classList.toggle('active', type === 'flow');
            document.getElementById('massLabel').textContent = type === 'mass' ? 'è´¨é‡/ä½“ç§¯å€¼' : 'æµé‡å€¼';
            updateUnitSelect();
        }

        // æ›´æ–°å•ä½é€‰æ‹©
        function updateUnitSelect() {
            const select = document.getElementById('massUnit');
            const units = inputType === 'mass' ? massUnits : flowUnits;
            select.innerHTML = units.map(u => `<option value="${u.value}">${u.label}</option>`).join('');
        }

        // æ›´æ–°å¯†åº¦æç¤º
        function updateDensityInfo() {
            if (selectedSubstance) {
                let density = selectedSubstance.density;
                let pressureInfo = '';
                
                if (selectedSubstance.category === 'gas') {
                    density = selectedSubstance.density * selectedPressure;
                    pressureInfo = ` (${selectedPressure}Barå‹åŠ›ä¸‹ at ${selectedPressure}Bar)`;
                }
                
                document.getElementById('densityInfo').innerHTML = 
                    `<strong>${selectedSubstance.name}</strong>${pressureInfo}çš„å¯†åº¦ Density: ${density.toFixed(3)} kg/mÂ³ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¿›è¡Œå•ä½æ¢ç®—ã€‚`;
            }
        }

        // æ›´æ–°æ¸©åº¦èŒƒå›´æç¤º
        function updateTempRange() {
            if (selectedSubstance) {
                let info = `<strong>${selectedSubstance.name}</strong> é€‚ç”¨æ¸©åº¦èŒƒå›´ï¼šæœ€ä½ ${selectedSubstance.tempMin}â„ƒ | æœ€é«˜ ${selectedSubstance.tempMax}â„ƒ`;
                if (selectedSubstance.category === 'liquid') {
                    info += ` | æ²¸ç‚¹ Boiling Point: ${selectedSubstance.boilingPoint}â„ƒ`;
                }
                if (selectedSubstance.category === 'other') {
                    info += ` | ç†”ç‚¹ Melting Point: ${selectedSubstance.meltingPoint}â„ƒ`;
                }
                document.getElementById('tempRange').innerHTML = info;
            }
        }

        // è®¾ç½®å†—ä½™ç³»æ•°
        function setRedundancy(value) {
            document.getElementById('redundancyFactor').value = value;
        }

        // éªŒè¯æ­¥éª¤
        function validateStep(step) {
            hideError(step);
            
            switch(step) {
                case 1:
                    if (!selectedSubstance) {
                        showError(1, 'è¯·é€‰æ‹©è¢«åŠ çƒ­ç‰©è´¨ Please select a substance');
                        return false;
                    }
                    return true;
                    
                case 2:
                    const massVal = parseFloat(document.getElementById('massValue').value);
                    if (!massVal || massVal <= 0) {
                        showError(2, 'è¯·è¾“å…¥æœ‰æ•ˆçš„è´¨é‡/ä½“ç§¯/æµé‡å€¼ Please enter a valid value');
                        return false;
                    }
                    return true;
                    
                case 3:
                    const initialT = parseFloat(document.getElementById('initialTemp').value);
                    const targetT = parseFloat(document.getElementById('targetTemp').value);
                    
                    if (isNaN(initialT) || isNaN(targetT)) {
                        showError(3, 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ¸©åº¦å€¼ Please enter valid temperatures');
                        return false;
                    }
                    if (targetT <= initialT) {
                        showError(3, 'ç›®æ ‡æ¸©åº¦å¿…é¡»é«˜äºåˆå§‹æ¸©åº¦ Target temp must be higher than initial');
                        return false;
                    }
                    if (initialT < selectedSubstance.tempMin) {
                        showError(3, `åˆå§‹æ¸©åº¦ä¸èƒ½ä½äº ${selectedSubstance.tempMin}â„ƒ`);
                        return false;
                    }
                    if (targetT > selectedSubstance.tempMax) {
                        showError(3, `ç›®æ ‡æ¸©åº¦ä¸èƒ½è¶…è¿‡ ${selectedSubstance.tempMax}â„ƒ`);
                        return false;
                    }
                    if (selectedSubstance.category === 'liquid' && targetT >= selectedSubstance.boilingPoint) {
                        showError(3, `ç›®æ ‡æ¸©åº¦å·²è¾¾åˆ°æˆ–è¶…è¿‡æ²¸ç‚¹ ${selectedSubstance.boilingPoint}â„ƒ`);
                        return false;
                    }
                    return true;
                    
                case 4:
                    const time = parseFloat(document.getElementById('heatingTime').value);
                    if (!time || time <= 0) {
                        showError(4, 'è¯·è¾“å…¥æœ‰æ•ˆçš„åŠ çƒ­æ—¶é—´ Please enter a valid heating time');
                        return false;
                    }
                    return true;
                    
                case 5:
                    const k = parseFloat(document.getElementById('redundancyFactor').value);
                    if (isNaN(k) || k < 1 || k > 3) {
                        showError(5, 'å†—ä½™ç³»æ•°åº”åœ¨ 1.0 åˆ° 3.0 ä¹‹é—´ Factor should be between 1.0 and 3.0');
                        return false;
                    }
                    return true;
            }
            return true;
        }

        // æ˜¾ç¤º/éšè—é”™è¯¯
        function showError(step, message) {
            document.getElementById('error' + step).textContent = message;
            document.getElementById('error' + step).classList.remove('hidden');
        }

        function hideError(step) {
            document.getElementById('error' + step).classList.add('hidden');
        }

        // ä¸‹ä¸€æ­¥
        function nextStep() {
            if (!validateStep(currentStep)) return;
            
            if (currentStep < 6) {
                currentStep++;
                updateUI();
            }
            
            if (currentStep === 3) {
                updateDeltaT();
            }
            
            if (currentStep === 6) {
                updateSummary();
            }
        }

        // ä¸Šä¸€æ­¥
        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateUI();
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            for (let i = 1; i <= 7; i++) {
                document.getElementById('content' + i).classList.add('hidden');
                document.getElementById('step' + i).classList.remove('active', 'completed');
            }
            
            document.getElementById('content' + currentStep).classList.remove('hidden');
            
            for (let i = 1; i <= 7; i++) {
                if (i < currentStep) {
                    document.getElementById('step' + i).classList.add('completed');
                } else if (i === currentStep) {
                    document.getElementById('step' + i).classList.add('active');
                }
            }
            
            const progress = ((currentStep - 1) / 6) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `æ­¥éª¤ ${currentStep} / 7`;
            
            document.getElementById('prevBtn').disabled = currentStep === 1;
            document.getElementById('nextBtn').classList.toggle('hidden', currentStep >= 6);
            document.getElementById('calcBtn').classList.toggle('hidden', currentStep !== 6);
        }

        // æ›´æ–°æ¸©å·®æ˜¾ç¤º
        function updateDeltaT() {
            const initialT = parseFloat(document.getElementById('initialTemp').value);
            const targetT = parseFloat(document.getElementById('targetTemp').value);
            const deltaDiv = document.getElementById('deltaT');
            
            if (!isNaN(initialT) && !isNaN(targetT) && targetT > initialT) {
                const delta = targetT - initialT;
                deltaDiv.textContent = `æ¸©å·® Î”T = ${delta.toFixed(1)} K`;
                deltaDiv.classList.remove('hidden');
            } else {
                deltaDiv.classList.add('hidden');
            }
        }

        document.getElementById('initialTemp').addEventListener('input', updateDeltaT);
        document.getElementById('targetTemp').addEventListener('input', updateDeltaT);

        // æ›´æ–°æ±‡æ€»è¡¨
        function updateSummary() {
            const massValue = document.getElementById('massValue').value;
            const massUnit = document.getElementById('massUnit').value;
            const initialT = document.getElementById('initialTemp').value;
            const targetT = document.getElementById('targetTemp').value;
            const heatingTime = document.getElementById('heatingTime').value;
            const timeUnit = document.getElementById('timeUnit').value;
            const k = document.getElementById('redundancyFactor').value;
            
            const deltaT = (parseFloat(targetT) - parseFloat(initialT)).toFixed(1);
            
            let pressureRow = '';
            if (selectedSubstance.category === 'gas') {
                pressureRow = `<tr><td>å·¥ä½œå‹åŠ› Pressure</td><td>${selectedPressure}</td><td>Bar</td></tr>`;
            }
            
            const tbody = document.querySelector('#summaryTable tbody');
            tbody.innerHTML = `
                <tr><td>è¢«åŠ çƒ­ç‰©è´¨ Substance</td><td>${selectedSubstance.name}</td><td>-</td></tr>
                ${pressureRow}
                <tr><td>${inputType === 'mass' ? 'è´¨é‡ Mass' : 'æµé‡ Flow'}</td><td>${massValue}</td><td>${massUnit}</td></tr>
                <tr><td>åˆå§‹æ¸©åº¦ Initial Temp</td><td>${initialT}</td><td>â„ƒ</td></tr>
                <tr><td>ç›®æ ‡æ¸©åº¦ Target Temp</td><td>${targetT}</td><td>â„ƒ</td></tr>
                <tr><td>æ¸©å·® Î”T</td><td>${deltaT}</td><td>K</td></tr>
                <tr><td>åŠ çƒ­æ—¶é—´ Time</td><td>${heatingTime}</td><td>${timeUnit}</td></tr>
                <tr><td>å†—ä½™ç³»æ•° Factor K</td><td>${k}</td><td>-</td></tr>
            `;
            
            let density = selectedSubstance.density;
            let pressureInfo = '';
            if (selectedSubstance.category === 'gas') {
                density = selectedSubstance.density * selectedPressure;
                pressureInfo = ` | å‹åŠ›: ${selectedPressure}Bar`;
            }
            
            document.getElementById('propsSummary').innerHTML = 
                `<strong>ç‰©æ€§å‚æ•° Properties:</strong>å¯†åº¦ Density: ${density.toFixed(3)} kg/mÂ³${pressureInfo} | æ¯”çƒ­å®¹ Cp: ${selectedSubstance.specificHeat} J/(kgÂ·K) | æ²¸ç‚¹ Boiling Point: ${selectedSubstance.boilingPoint}â„ƒ`;
        }

        // è®¡ç®—
        function calculate() {
            if (!validateStep(5)) return;
            
            const massValue = parseFloat(document.getElementById('massValue').value);
            const massUnit = document.getElementById('massUnit').value;
            const initialT = parseFloat(document.getElementById('initialTemp').value);
            const targetT = parseFloat(document.getElementById('targetTemp').value);
            const heatingTime = parseFloat(document.getElementById('heatingTime').value);
            const timeUnit = document.getElementById('timeUnit').value;
            const k = parseFloat(document.getElementById('redundancyFactor').value);
            
            let density = selectedSubstance.density;
            if (selectedSubstance.category === 'gas') {
                density = selectedSubstance.density * selectedPressure;
            }
            
            const units = inputType === 'mass' ? massUnits : flowUnits;
            const unitInfo = units.find(u => u.value === massUnit);
            
            let mass = massValue * unitInfo.factor;
            if (unitInfo.needsDensity) {
                mass *= density;
            }
            
            const timeHours = heatingTime * timeFactors[timeUnit];
            const deltaT = targetT - initialT;
            
            let power, formula;
            if (inputType === 'flow') {
                power = (selectedSubstance.specificHeat * mass * deltaT) / 3600 / 1000 * k;
                formula = `P(KW) = C Ã— á¹ Ã— Î”T / 3600 / 1000 Ã— K\n` +
                         `P = ${selectedSubstance.specificHeat} Ã— ${mass.toFixed(2)} Ã— ${deltaT} / 3600 / 1000 Ã— ${k}\n` +
                         `P = ${power.toFixed(2)} KW`;
            } else {
                power = (selectedSubstance.specificHeat * mass * deltaT) / (timeHours * 3600 * 1000) * k;
                formula = `P(KW) = C Ã— m Ã— Î”T / (t Ã— 3600 Ã— 1000) Ã— K\n` +
                         `P = ${selectedSubstance.specificHeat} Ã— ${mass.toFixed(2)} Ã— ${deltaT} / (${timeHours.toFixed(2)} Ã— 3600 Ã— 1000) Ã— ${k}\n` +
                         `P = ${power.toFixed(2)} KW`;
            }
            
            document.getElementById('resultPower').textContent = power.toFixed(2);
            document.getElementById('formulaBox').textContent = formula;
            
            let pressureRow = '';
            if (selectedSubstance.category === 'gas') {
                pressureRow = `<tr><td>å·¥ä½œå‹åŠ› Pressure</td><td>${selectedPressure}</td><td>Bar</td></tr>`;
            }
            
            const tbody = document.querySelector('#resultTable tbody');
            tbody.innerHTML = `
                <tr><td>ç‰©è´¨ Substance</td><td>${selectedSubstance.name}</td><td>-</td></tr>
                ${pressureRow}
                <tr><td>æ¯”çƒ­å®¹ Cp</td><td>${selectedSubstance.specificHeat}</td><td>J/(kgÂ·K)</td></tr>
                <tr><td>è´¨é‡ Mass</td><td>${mass.toFixed(2)}</td><td>kg</td></tr>
                <tr><td>æ¸©å·® Î”T</td><td>${deltaT}</td><td>K</td></tr>
                <tr><td>åŠ çƒ­æ—¶é—´ Time</td><td>${timeHours.toFixed(2)}</td><td>h</td></tr>
                <tr><td>å†—ä½™ç³»æ•° Factor K</td><td>${k}</td><td>-</td></tr>
            `;
            
            currentStep = 7;
            updateUI();
        }

        // é‡ç½®
        function resetAll() {
            currentStep = 1;
            selectedSubstance = null;
            selectedPressure = 1;
            inputType = 'mass';
            currentCategory = 'all';
            
            document.getElementById('searchInput').value = '';
            document.getElementById('massValue').value = '';
            document.getElementById('initialTemp').value = '';
            document.getElementById('targetTemp').value = '';
            document.getElementById('heatingTime').value = '';
            document.getElementById('redundancyFactor').value = '1.2';
            document.getElementById('selectedSubstance').classList.add('hidden');
            document.getElementById('pressureSelection').classList.add('hidden');
            document.getElementById('deltaT').classList.add('hidden');
            
            document.querySelectorAll('.toggle-group .toggle-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === 0);
            });
            
            setInputType('mass');
            renderSubstances();
            updateUI();
            
            for (let i = 1; i <= 5; i++) {
                hideError(i);
            }
        }

        // ==================== æ·»åŠ ç‰©è´¨æ¨¡æ€æ¡†åŠŸèƒ½ ====================
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showAddSubstanceModal() {
            document.getElementById('addSubstanceModal').classList.remove('hidden');
            resetAddModal();
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeAddSubstanceModal() {
            document.getElementById('addSubstanceModal').classList.add('hidden');
        }
        
        // é‡ç½®æ¨¡æ€æ¡†
        function resetAddModal() {
            addStep = 1;
            addCategory = null;
            
            for (let i = 1; i <= 3; i++) {
                document.getElementById('addStep' + i).classList.remove('active', 'completed');
                document.getElementById('addContent' + i).classList.add('hidden');
            }
            document.getElementById('addStep1').classList.add('active');
            document.getElementById('addContent1').classList.remove('hidden');
            
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('selected'));
            
            document.getElementById('customNameCn').value = '';
            document.getElementById('customNameEn').value = '';
            document.getElementById('customDensity').value = '';
            document.getElementById('customSpecificHeat').value = '';
            document.getElementById('customTempMin').value = '';
            document.getElementById('customTempMax').value = '';
            document.getElementById('customDescription').value = '';
            
            document.getElementById('addPrevBtn').disabled = true;
            document.getElementById('addNextBtn').classList.remove('hidden');
            document.getElementById('addSaveBtn').classList.add('hidden');
            
            for (let i = 1; i <= 3; i++) {
                document.getElementById('addError' + i).classList.add('hidden');
            }
        }
        
        // é€‰æ‹©åˆ†ç±»
        function selectAddCategory(category) {
            addCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.closest('.category-btn').classList.add('selected');
            document.getElementById('addError1').classList.add('hidden');
        }
        
        // ä¸‹ä¸€æ­¥
        function nextAddStep() {
            if (!validateAddStep(addStep)) return;
            
            if (addStep < 3) {
                document.getElementById('addStep' + addStep).classList.remove('active');
                document.getElementById('addStep' + addStep).classList.add('completed');
                document.getElementById('addContent' + addStep).classList.add('hidden');
                
                addStep++;
                
                document.getElementById('addStep' + addStep).classList.add('active');
                document.getElementById('addContent' + addStep).classList.remove('hidden');
                
                document.getElementById('addPrevBtn').disabled = false;
                
                if (addStep === 3) {
                    document.getElementById('addNextBtn').classList.add('hidden');
                    document.getElementById('addSaveBtn').classList.remove('hidden');
                }
            }
        }
        
        // ä¸Šä¸€æ­¥
        function prevAddStep() {
            if (addStep > 1) {
                document.getElementById('addStep' + addStep).classList.remove('active');
                document.getElementById('addContent' + addStep).classList.add('hidden');
                
                addStep--;
                
                document.getElementById('addStep' + addStep).classList.remove('completed');
                document.getElementById('addStep' + addStep).classList.add('active');
                document.getElementById('addContent' + addStep).classList.remove('hidden');
                
                document.getElementById('addPrevBtn').disabled = addStep === 1;
                document.getElementById('addNextBtn').classList.remove('hidden');
                document.getElementById('addSaveBtn').classList.add('hidden');
            }
        }
        
        // éªŒè¯æ­¥éª¤
        function validateAddStep(step) {
            const addErrorDiv = document.getElementById('addError' + step);
            addErrorDiv.classList.add('hidden');
            
            switch(step) {
                case 1:
                    if (!addCategory) {
                        addErrorDiv.textContent = 'è¯·é€‰æ‹©ç‰©è´¨åˆ†ç±» Please select a category';
                        addErrorDiv.classList.remove('hidden');
                        return false;
                    }
                    return true;
                    
                case 2:
                    const nameCn = document.getElementById('customNameCn').value.trim();
                    const nameEn = document.getElementById('customNameEn').value.trim();
                    
                    if (!nameCn) {
                        addErrorDiv.textContent = 'è¯·è¾“å…¥ä¸­æ–‡åç§° Please enter Chinese name';
                        addErrorDiv.classList.remove('hidden');
                        return false;
                    }
                    if (!nameEn) {
                        addErrorDiv.textContent = 'è¯·è¾“å…¥è‹±æ–‡åç§° Please enter English name';
                        addErrorDiv.classList.remove('hidden');
                        return false;
                    }
                    if (substanceDatabase.find(s => s.name === nameCn)) {
                        addErrorDiv.textContent = 'è¯¥ä¸­æ–‡åç§°å·²å­˜åœ¨ This Chinese name already exists';
                        addErrorDiv.classList.remove('hidden');
                        return false;
                    }
                    return true;
                    
                case 3:
                    const density = parseFloat(document.getElementById('customDensity').value);
                    const specificHeat = parseFloat(document.getElementById('customSpecificHeat').value);
                    const tempMin = parseFloat(document.getElementById('customTempMin').value);
                    const tempMax = parseFloat(document.getElementById('customTempMax').value);
                    
                    if (!density || density <= 0) {
                        addErrorDiv.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„å¯†åº¦å€¼ Please enter a valid density';
                        addErrorDiv.classList.remove('hidden');
                        return false;
                    }
                    if (!specificHeat || specificHeat <= 0) {
                        addErrorDiv.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ¯”çƒ­å®¹å€¼ Please enter a valid specific heat';
                        addErrorDiv.classList.remove('hidden');
                        return false;
                    }
                    if (isNaN(tempMin)) {
                        addErrorDiv.textContent = 'è¯·è¾“å…¥æœ€ä½æ¸©åº¦ Please enter minimum temperature';
                        addErrorDiv.classList.remove('hidden');
                        return false;
                    }
                    if (isNaN(tempMax)) {
                        addErrorDiv.textContent = 'è¯·è¾“å…¥æœ€é«˜æ¸©åº¦ Please enter maximum temperature';
                        addErrorDiv.classList.remove('hidden');
                        return false;
                    }
                    if (tempMax <= tempMin) {
                        addErrorDiv.textContent = 'æœ€é«˜æ¸©åº¦å¿…é¡»å¤§äºæœ€ä½æ¸©åº¦ Max temp must be higher than min temp';
                        addErrorDiv.classList.remove('hidden');
                        return false;
                    }
                    return true;
            }
            return true;
        }
        
        // ä¿å­˜è‡ªå®šä¹‰ç‰©è´¨
        function saveCustomSubstance() {
            if (!validateAddStep(3)) return;
            
            const nameCn = document.getElementById('customNameCn').value.trim();
            const nameEn = document.getElementById('customNameEn').value.trim();
            const density = parseFloat(document.getElementById('customDensity').value);
            const specificHeat = parseFloat(document.getElementById('customSpecificHeat').value);
            const tempMin = parseFloat(document.getElementById('customTempMin').value);
            const tempMax = parseFloat(document.getElementById('customTempMax').value);
            const description = document.getElementById('customDescription').value.trim() || 'è‡ªå®šä¹‰ç‰©è´¨';
            
            const newSubstance = {
                name: nameCn,
                nameEn: nameEn,
                category: addCategory,
                density: density,
                specificHeat: specificHeat,
                boilingPoint: tempMax,
                meltingPoint: tempMin,
                description: description,
                tempMin: tempMin,
                tempMax: tempMax,
                isCustom: true
            };
            
            substanceDatabase.push(newSubstance);
            saveCustomSubstanceToStorage(newSubstance);
            closeAddSubstanceModal();
            renderSubstances();
            
            alert(`âœ… ç‰©è´¨ "${nameCn}" å·²æˆåŠŸæ·»åŠ ï¼\nSubstance "${nameEn}" has been added successfully!`);
        }
    </script>
</body>
</html>
